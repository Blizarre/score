<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>üèπ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <style>
        body {
            font-family: sans-serif;
            font-size: 200%;
            margin: 20px;
            text-align: center;
        }

        table {
            width: 80%;
            border-collapse: collapse;
            margin: 30px;
            margin-left: auto;
            margin-right: auto;
            font-size: 70%;
            text-align: center;
        }

        thead {
            font-weight: bold;
        }

        button {
            width: 25%;
            height: 65px;
            font-weight: bold;
            margin: 2px;
            font-size: 100%;
        }


        td {
            border: 1px solid black;
            padding: 5px;
        }

        #total_score {
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div>
        <button onclick="add_to_total_score_element(this)">1</button>
        <button onclick="add_to_total_score_element(this)">2</button>
        <button onclick="add_to_total_score_element(this)">3</button>
        <button onclick="add_to_total_score_element(this)">4</button>
        <button onclick="add_to_total_score_element(this)">5</button>
        <button onclick="add_to_total_score_element(this)">6</button>
        <button onclick="add_to_total_score_element(this)">7</button>
        <button onclick="add_to_total_score_element(this)">8</button>
        <button onclick="add_to_total_score_element(this)">9</button>
        <button onclick="add_to_total_score_element(this)">0</button>
        <button onclick="delete_last_score()">‚å´</button>
        <button onclick="reset_state()">üóëÔ∏è</button>
    </div>

    <table id="current_row"></table>

    <table id="scoresheet"></table>

    <h2>Total score üèπ</h2>
    <div id="total_score">0</div>

    <script>
        State = {
            push: function (score) {
                state = JSON.parse(localStorage.getItem("state") || "[]")
                state.push(score);
                localStorage.setItem("state", JSON.stringify(state))
            },
            pop: function () {
                state = JSON.parse(localStorage.getItem("state") || "[]")
                state.pop();
                localStorage.setItem("state", JSON.stringify(state))
            },
            clear: function () {
                localStorage.setItem("state", JSON.stringify([]))
            },
            get: function () {
                return JSON.parse(localStorage.getItem("state") || "[]")
            }
        }

        function add_to_total_score_element(element) {
            var score = parseInt(element.innerHTML)
            add_to_total_score(score)
        }

        function add_to_total_score(value) {
            var state = State.get()
            // Make sure that the numbers are in descending order for a row
            if (state.length % 6 > 0) {
                last_element = State.get().slice(-1)[0];
                if (value > last_element) {
                    alert("You can't add a number that is bigger than the previous number in the end")
                    return;
                }
            }

            State.push(value)
            refresh_ui();
        }

        function delete_last_score() {
            State.pop();
            refresh_ui();
        }


        function reset_state() {
            State.clear();
            refresh_ui();
        }

        function create_cell(value) {
            var cell = document.createElement("td");
            cell.innerHTML = value;
            return cell;
        }

        function refresh_ui() {
            var table_all = document.getElementById("scoresheet");
            var table_preview = document.getElementById("current_row");
            var total_score = 0;

            // table for the full scoresheet
            table_all.innerHTML = `
                <thead>
                    <tr>
                        <td colspan=6>Score</td>
                        <td>End Score</td>
                        <td>2 end Score</td>
                        <td>Cum. Score</td>
                    </tr>
                </thead>`;

            // table for the small preview at the top (so we always see the scores we enter,
            // no matter how many rows we have)
            table_preview.innerHTML = ""

            state = State.get();

            // Used to keep track of the Cumulative score of the last 2 ends (one dozen arrows)
            // This is used to calculate the "2 end score" column
            var cell_2end_score = null;
            var last_score = 0;

            // Create as many rows of up to 6 elements from the state as possible
            while (state.length > 0) {
                var new_row = document.createElement("tr");
                var row_score = 0;
                for (var i = 0; i < 6; i++) {
                    if (state.length > 0) {
                        var score = parseInt(state.shift())
                        var cell = create_cell(score);
                        row_score += score;
                        new_row.appendChild(cell);
                    } else {
                        new_row.appendChild(create_cell("-"));
                    }
                }
                total_score += row_score;

                /* Preview table */

                // If we are on the last row (no more state to pop() from),
                // display that row on the preview table (make a copy without the additional cells)
                if (state.length == 0) {
                    table_preview.replaceChildren(new_row.cloneNode(true))
                }

                /* End Score Column */
                new_row.appendChild(create_cell(row_score));

                /* 2 end Score Column */
                if (cell_2end_score == null) {
                    // If we don't have a cell_2end_score, create it and add it to the row
                    cell_2end_score = create_cell(0);
                    cell_2end_score.rowSpan = 2;
                    new_row.appendChild(cell_2end_score);
                } else {
                    // If we have a cell_2end_score, write the score of the last 2 end and add it to the row.
                    // Then reset it for the next iteration
                    cell_2end_score.innerText = row_score + last_score;
                    cell_2end_score = null;
                }
                last_score = row_score;


                /* Cumulative Score Column */
                new_row.appendChild(create_cell(total_score));


                /* Update the table with the new row */

                table_all.appendChild(new_row);

            }

            var total_score = document.getElementById("total_score").innerHTML = total_score;
        }

        // capture keyboard and call add_to_total_score with the number
        document.onkeypress = function (e) {
            e = e || window.event;
            var charCode = (typeof e.which == "number") ? e.which : e.keyCode;
            if (charCode) {
                var number = String.fromCharCode(charCode);
                if (number >= '0' && number <= '9') {
                    add_to_total_score(number);
                }
            }
        };

        refresh_ui();

    </script>

</html>